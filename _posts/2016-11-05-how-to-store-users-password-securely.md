---
layout: post
title: "用户密码加密存储十问十答"
description: ""
category: Security 
tags: [Web, Password, Hash]
---
{% include JB/setup %}

### 我们数据库的权限管理十分严格，敏感信息开发工程师都看不到，密码明文存储不行吗？

不行。存储在数据库的数据面临很多威胁，有应用程序层面、数据库层面的、操作系统层面的、机房层面的、员工层面的，想做到百分百不被黑客窃取，非常困难。

如果密码是加密之后再存储，那么即便被拖库，黑客也难以获取用户的明文密码。可以说，密码加密存储是用户账户系统的底裤，它的重要性，相当于你独自出远门时缝在内衣里钱，虽然你用到他们的概率不大，但关键时刻他们能救命。

### 那用加密算法比如AES，把密码加密下再存，需要明文的时候我再解密。

不行。这涉及到怎么保存用来加密解密的密钥，虽然密钥一般跟用户信息分开存储，且业界也有一些成熟的、基于软件或硬件的密钥存储方案。但跟用户信息的保存一样，想要密钥百分百不泄露，不可能做到。用这种方式加密密码，能够降低黑客获取明文密码的概率。但密钥一旦泄露，用户的明文密码也就泄露了，不是一个好方法。

另外，用户账户系统不应该保存用户的明文密码，在用户忘记密码的时候，提供重置密码的功能而不是找回密码。

### 保存所有密码的HASH值，比如MD5。是不是就可以了？

不是所有的HASH算法都可以，准确讲应该是[Cryptographic Hash](https://en.wikipedia.org/wiki/Cryptographic_hash_function)。Cryptographic Hash具有如下几个特点：

1. 给定任意大小任意类型的输入，计算hash非常快；
2. 给定一个hash，没有办法计算得出该hash所对应的输入；
3. 对输入做很小改动，hash就会发生很大变化;
4. 没有办法计算得到两个hash相同的输入;

虽然不是为加密密码而设计，但其第2、3、4三个特性使得Cryptographic Hash非常适合用来加密用户密码。常见的Cryptographic Hash有MD5、SHA-1、SHA-2、SHA-3/Keccak、BLAKE2。

从1976年开始，业界开始使用Cryptographic Hash加密用户密码，最早见于Unix Crypt。但MD5、SHA-1已被破解，不适合再用来保存密码。

### 那我保存用户密码的SHA256值。

不行。黑客可以用查询表或彩虹表来破解用户密码。注意是破解密码不是破解sha256，能根据sha256破解密码的原因是，用户密码往往需要大脑记忆、手工输入，所以不会太复杂，往往具有有限的长度、确定的取值空间。

- 短的取值简单的密码可以用查询表破解

比如8位数字密码，一共只有10^8=100000000种可能。一亿条数据并不算多，黑客可以提前吧0-99999999的sha256都计算好，并以sha256做key密码为value存储为一个查询表，当给定sha256需要破解时，从表中查询即可。

- 取值相对复杂，且长度较长的密码，可以用彩虹表破解

比如10位，允许数字、字母大小写的密码，一共有(10+26+26)^10~=84亿亿种可能，记录非常之多难以用查询表全部保存起来。这时候黑客会用一种叫做彩虹表的技术来破解，彩虹表用了典型的计算机世界里解决问题的思路，时间空间妥协。在这个例子里面，空间不够，那就多花一些时间。在彩虹表中，可以将全部的sha256值转化为长度相同的若干条hash链，只保存hash链的头和尾，在破解的时候先查询得到sha256存在于哪条hash链中，然后计算这一条hash链上的所有sha256，通过实时比对来破解用户密码。

![rainbow table](http://zhaox.github.io/assets/images/RainbowTable.svg)

上图图展示了一个hash链长度为3的彩虹表，因为在hash链中需要将hash值使用R函数映射回密码取值空间，为了降低R函数的冲突概率，长度为K的hash链中，彩虹表会使用k个R函数，因为每次迭代映射回密码空间使用的R函数不一样，这种破解方法被称作彩虹表攻击。

实际的情况Hash链要比远比上例更长，比如我们的例子中全部的84亿亿个sha256存不下，可以转化为840亿条长度为1千万的sha链。对彩虹表原理感兴趣的话，可以阅读它的[维基百科](https://en.wikipedia.org/wiki/Rainbow_table)。

网路上甚至有一些[已经计算好的彩虹表(http://project-rainbowcrack.com/table.htm)可以直接使用，所以直接保存用户密码的sha256是非常不安全的。

### 怎样避免彩虹表攻击？

简单讲，就是加盐。一般来讲用户密码是个字符串key、盐是我们生成的字符串salt。原来我们保存的是key的hash值HASH(key)，现在我们保存key和salt拼接在一起的hash值HASH(key+salt)。

这样黑客提前计算生成的彩虹表，就全都失效了。

### 盐应该怎么生成，随机生成一个字符串？

### 为每一个密码都加上不同的高质量的盐，做HASH，然后保存。这样可以了吧？

### 那我自己设计一个黑客不知道的HASH算法，这样你的那些破解方法就都失效了。

### 哪一种Password Hash是最好的密码加密算法？

### 一路问过来好累，能不能给我举个例子，大公司是怎么加密用户密码的？
